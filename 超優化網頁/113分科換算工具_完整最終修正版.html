<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºæ…§å‡å­¸è©•ä¼°å·¥å…·</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background-color: #f7f9fc;
      color: #333;
      padding: 20px;
      margin: 0;
    }
    .card {
      background: #fff;
      padding: 15px;
      margin: 20px auto;
      border-radius: 10px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      max-width: 900px;
    }
    input, select, button {
      padding: 8px;
      margin: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      transition: 0.3s ease;
    }
    button:hover, input:focus, select:focus {
      border-color: #4a90e2;
      box-shadow: 0 0 8px rgba(74,144,226,0.4);
      outline: none;
    }
    h2 { color: #4a90e2; }
    .flex-wrap { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .results { margin-top: 20px; background: #eaf4fe; padding: 15px; border-radius: 10px; }
    .score-box { text-align: center; width: 140px; }
    .score-box small { display: block; color: #555; margin-top: 4px; font-size: 12px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>å­¸æ¸¬æˆç¸¾è¼¸å…¥</h2>
    <div class="flex-wrap" id="scoreInputs"></div>
  </div>

  <div class="card">
    <h2>æ ¡ç³»é¸æ“‡</h2>
    <select id="yearList" onchange="updateSchools()"></select>
    <select id="schoolList" onchange="updateDepartments()"></select>
    <select id="departmentList" onchange="displayDepartmentDetails()"></select>
    <div id="departmentResults"></div>
    <button onclick="addToEvaluation()">åŠ å…¥è©•ä¼°</button>
  </div>

  <div class="card">
    <h2>è©•ä¼°æ¸…å–®</h2>
    <div id="evaluationList"></div>
  </div>

  <script>
    const subjects = ["åœ‹æ–‡", "è‹±æ–‡", "æ•¸A", "æ•¸B", "ç¤¾æœƒ", "è‡ªç„¶"];
    const advancedSubjects = ["æ•¸ç”²", "ç‰©", "åŒ–", "ç”Ÿ", "æ­·", "åœ°", "å…¬"];
    const subjectWeights = ["åœ‹å€ç‡", "è‹±å€ç‡", "æ•¸Aå€ç‡", "æ•¸Bå€ç‡", "ç¤¾æœƒå€ç‡", "è‡ªç„¶å€ç‡", "æ•¸ç”²å€ç‡", "ç‰©å€ç‡", "åŒ–å€ç‡", "ç”Ÿå€ç‡", "æ­·å€ç‡", "åœ°å€ç‡", "å…¬å€ç‡"];

    const scoreInputsDiv = document.getElementById('scoreInputs');
    const userScores = {};
    subjects.forEach(sub => {
      scoreInputsDiv.innerHTML += `
        <div class="score-box">
          ${sub}<br>
          <input type="number" id="${sub}" min="0" max="15" onchange="updateScore('${sub}')">
          <small id="display-${sub}"></small>
        </div>`;
    });

    function convertScore(x) {
      return { max: x * 4, min: Math.max(x * 4 - 3, 0) };
    }

    function updateScore(sub) {
      const val = Math.max(0, Math.min(15, parseInt(document.getElementById(sub).value || 0)));
      document.getElementById(sub).value = val;
      const score = convertScore(val);
      userScores[sub] = score;
      document.getElementById(`display-${sub}`).innerText = `æœ€ä½ï¼š${score.min}ï¼Œæœ€é«˜ï¼š${score.max}`;
    }

    let csvData;
    let evaluationData = [];

    Papa.parse("111_112_113_åˆä½µå€ç‡è³‡æ–™.csv", {
      download: true,
      header: true,
      complete: function(results) {
        csvData = results.data;
        initializeYearList();
      }
    });

    function initializeYearList() {
      const years = [...new Set(csvData.map(d => d['å¹´åº¦']).filter(Boolean))];
      const yearList = document.getElementById('yearList');
      yearList.innerHTML = '<option value="">é¸æ“‡å¹´åº¦</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    function updateSchools() {
      const year = document.getElementById('yearList').value;
      const schools = [...new Set(csvData.filter(d => d['å¹´åº¦'] === year).map(d => d['æ ¡å']))];
      const schoolList = document.getElementById('schoolList');
      schoolList.innerHTML = '<option value="">é¸æ“‡å¤§å­¸æ ¡å</option>' + schools.map(s => `<option value="${s}">${s}</option>`).join('');
      document.getElementById('departmentList').innerHTML = '<option value="">é¸æ“‡ç§‘ç³»åç¨±</option>';
    }

    function updateDepartments() {
      const year = document.getElementById('yearList').value;
      const school = document.getElementById('schoolList').value;
      const departments = csvData.filter(d => d['å¹´åº¦'] === year && d['æ ¡å'] === school);
      const deptList = document.getElementById('departmentList');
      deptList.innerHTML = '<option value="">é¸æ“‡ç§‘ç³»åç¨±</option>' + departments.map((d, i) => `<option value="${i}">${d['ç³»çµ„å']}</option>`).join('');
    }

    function displayDepartmentDetails() {
      const index = document.getElementById('departmentList').value;
      if (!index) return;
      const year = document.getElementById('yearList').value;
      const school = document.getElementById('schoolList').value;
      const deptData = csvData.filter(d => d['å¹´åº¦'] === year && d['æ ¡å'] === school)[index];
      if (!deptData) return;

      let html = `<strong>${deptData['å¹´åº¦']} ${deptData['æ ¡å']} ${deptData['ç³»çµ„å']}</strong><br>`;
      subjectWeights.forEach(sw => html += `${sw}: ${deptData[sw] || 0} `);
      html += `<br><strong>æœ€ä½éŒ„å–åˆ†æ•¸:</strong> ${deptData['æ™®é€šç”ŸéŒ„å–åˆ†æ•¸'] || 'N/A'} éŒ„å–äººæ•¸: ${deptData['éŒ„å–äººæ•¸'] || 'N/A'}`;

      document.getElementById('departmentResults').innerHTML = html;
    }

    function addToEvaluation() {
      if (evaluationData.length >= 10) return alert("æœ€å¤š10ç­†æ ¡ç³»ï¼");
      const index = document.getElementById('departmentList').value;
      const year = document.getElementById('yearList').value;
      const school = document.getElementById('schoolList').value;
      const deptData = csvData.filter(d => d['å¹´åº¦'] === year && d['æ ¡å'] === school)[index];
      evaluationData.push(deptData);
      renderEvaluationList();
    }

    function renderEvaluationList() {
      const elist = document.getElementById('evaluationList');
      elist.innerHTML = '';
      evaluationData.forEach((dept, idx) => {
        const minScore = parseFloat(dept['æ™®é€šç”ŸéŒ„å–åˆ†æ•¸']) || 0;
        let weightedBasicMax = 0;
        let weightedBasicMin = 0;
        let advancedWeightSum = 0;

        subjects.forEach(sub => {
          const weight = parseFloat(dept[sub + 'å€ç‡'] || 0);
          const score = userScores[sub] || { min: 0, max: 0 };
          weightedBasicMax += score.max * weight;
          weightedBasicMin += score.min * weight;
        });

        advancedSubjects.forEach(sub => {
          const weight = parseFloat(dept[sub + 'å€ç‡'] || 0);
          advancedWeightSum += weight;
        });

        const avgMin = ((minScore - weightedBasicMax) / (advancedWeightSum || 1)).toFixed(2);
        const avgMax = ((minScore - weightedBasicMin) / (advancedWeightSum || 1)).toFixed(2);

        elist.innerHTML += `
          <div><strong>${idx+1}. ${dept['å¹´åº¦']} ${dept['æ ¡å']} ${dept['ç³»çµ„å']}</strong><br>
          å„ç§‘å€ç‡ï¼š${subjectWeights.map(w => `${w}: ${dept[w] || 0}`).join(' ï½œ ')}<br>
          æœ€ä½éŒ„å–åˆ†æ•¸ï¼š${minScore} ï½œ éŒ„å–äººæ•¸ï¼š${dept['éŒ„å–äººæ•¸'] || 'N/A'}<br>
          ğŸ”¹ æœ€ä½åˆ†ç§‘å–®ç§‘å¹³å‡ç´šåˆ†ï¼š${avgMin} ï½œ ğŸ”¸ æœ€é«˜åˆ†ç§‘å–®ç§‘å¹³å‡ç´šåˆ†ï¼š${avgMax}<br>
          <button onclick="removeEvaluation(${idx})">ç§»é™¤</button><hr></div>`;
      });
    }

    function removeEvaluation(idx) {
      evaluationData.splice(idx, 1);
      renderEvaluationList();
    }
  </script>
</body>
</html>
